<style>
  .pagination {
  margin-top: 20px;
  display: flex;
  justify-content: center;
}
.pagination .page-item.active .page-link {
  background-color: #007bff;
  border-color: #007bff;
  color: white;
}
.pagination .page-item .page-link {
  color: #007bff;
}

</style>
<div class="grid-margin stretch-card">
  <div class="card">
    <div class="card-body">
      <h4 class="card-title">Order History</h4>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Order Id</th>
              <th>User Id</th>
              <th>Payment Type</th>
              <th>Order Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <% order_history.forEach(order => { %>
              <!-- Main row with basic order details -->
              <tr class="order-row">
                <td><%= order.orderId %></td>
                <td><%= order.user.username %></td>
                <td><%= order.paymentMethod %></td>
                <td><label class="badge badge-warning"><%= order.orderStatus %></label></td>
                <td>
                  <button class="btn btn-info toggle-details-btn">Show Details</button>
                </td>
              </tr> 
              <!-- First child row for order items and address -->
              <tr class="order-details-row" style="display:none;">
                <td colspan="5">
                  <div class="row order-details">
                    <!-- Product items details -->
                    <div class="col-lg-6 order-items">
                      <% order.items.forEach(item => { %>
                        <div class="item-details">
                          <img src="/<%= item.product.variants.find(v => v._id.toString() === item.variantId.toString()).images[0] %>" alt="Product Image" width="50px">
                          <p><strong>Product:</strong> <%= item.product.product_name %></p>
                          <p><strong>Color:</strong> <%= item.product.variants.find(v => v._id.toString() === item.variantId.toString()).color %></p>
                          <p><strong>Storage:</strong> <%= item.product.variants.find(v => v._id.toString() === item.variantId.toString()).storage_size %></p>
                        </div>
                      <% }) %>
                    </div>
                    <div class="col-lg-6 address-details">
                      <h5>Shipping Address</h5>
                      <p><strong>Full Name:</strong> <%= order.address.fullName %></p>
                      <p><strong>Address Line 2:</strong> <%= order.address.streetAddress %></p>
                      <p><strong>City:</strong> <%= order.address.city %></p>
                      <p><strong>Phone Number:</strong> <%= order.address.phoneNumber %></p>
                      <p><strong>Email :</strong> <%= order.address.emailAddress %></p>

                    </div>
                  </div>
                </td>
              </tr>
              
              
              <!-- Second child row for status actions -->
              <tr class="order-actions-row" style="display:none;">
                <td colspan="5">
                  <div class="status-actions">
                    <p>Update Status:</p>
                    <button class="btn btn-primary status-btn" data-status="Processing" data-order-id="<%= order._id %>">Processing</button>
                    <button class="btn btn-info status-btn" data-status="Shipped" data-order-id="<%= order._id %>">Shipped</button>
                    <button class="btn btn-success status-btn" data-status="Delivered" data-order-id="<%= order._id %>">Delivered</button>
                    <button class="btn btn-da8/yunger status-btn" data-status="Cancelled" data-order-id="<%= order._id %>">Cancelled</button>
                  </div>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<div class="pagination">
  <nav aria-label="Page navigation example">
    <ul class="pagination">
      <% if (currentPage > 1) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= currentPage - 1 %>" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
      <% } %>

      <% for (let i = 1; i <= totalPages; i++) { %>
        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
          <a class="page-link" href="?page=<%= i %>"><%= i %></a>
        </li>
      <% } %>

      <% if (currentPage < totalPages) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= currentPage + 1 %>" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      <% } %>
    </ul>
  </nav>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  $(document).ready(function() {
    // Toggle details and actions row visibility
    $('.toggle-details-btn').on('click', function() {
      const $parentRow = $(this).closest('tr');
      $parentRow.next('.order-details-row').toggle();
      $parentRow.next('.order-details-row').next('.order-actions-row').toggle();
      $(this).text($(this).text() === 'Show Details' ? 'Hide Details' : 'Show Details');
    });

    // Handle status change
    $('.status-btn').on('click', function() {
      const status = $(this).data('status');
      const orderId = $(this).data('order-id');

      Swal.fire({
        title: `Are you sure you want to update the status to "${status}"?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, update it!'
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            url: '/admin/update-order-status', 
            method: 'POST',
            data: { orderId: orderId, status: status },
            success: function(response) {
              Swal.fire(
                'Updated!',
                `The order status has been updated to "${status}".`,
                'success'
              ).then(() => {
                location.reload();
              });
            },
            error: function(err) {
              Swal.fire(
                'Failed!',
                'There was an issue updating the status. Please try again.',
                'error'
              );
            }
          });
        }
      });
    });
  });
</script>
