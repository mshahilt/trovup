
<div class="grid-margin stretch-card">
  <div class="card">
    <div class="card-body">
      <h4 class="card-title">Order History</h4>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Order Id</th>
              <th>User</th>
              <th>Payment Type</th>
              <th>Order Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <% order_history.forEach(order => { %>
              <!-- Main order row -->
              <tr class="order-row">
                <td><%= order.orderId %></td>
                <td><%= order.user.username %></td>
                <td><%= order.paymentMethod %></td>
                <td><label class="badge badge-info"><%= order.orderStatus %></label></td>
                <td>
                  <button class="btn btn-info toggle-details-btn">Show Details</button>
                </td>
              </tr>

              <!-- Child row for order details -->
              <tr class="order-details-row" style="display:none;">
                <td colspan="5">
                  <div class="order-details">
                    <div class="row">
                      <!-- Products for the order -->
                      <div class="col-lg-6 order-items">
                        <h5>Ordered Products</h5>
                        <% order.items.forEach(item => { %>
                          <div class="item-details">
                            <img src="/<%= item.product.variants.find(v => v._id.toString() === item.variantId.toString()).images[0] %>" alt="Product Image" width="50px">
                            <p><strong>Product:</strong> <%= item.product.product_name %></p>
                            <p><strong>Color:</strong> <%= item.product.variants.find(v => v._id.toString() === item.variantId.toString()).color %></p>
                            <p><strong>Storage:</strong> <%= item.product.variants.find(v => v._id.toString() === item.variantId.toString()).storage_size %></p>
                          </div>

                          <!-- Status actions for each product -->
                          <div class="status-actions">
                            <strong>Status:</strong> 
                            <label class="badge badge-<%= item.status === 'Cancelled' ? 'danger' : item.status === 'Delivered' ? 'success' : item.status === 'Shipped' ? 'info' : 'primary' %>"><%= item.status %></label>
                            <br>
                            <button class="btn btn-primary btn-status <%= item.status !== 'Processing' ? 'disabled' : '' %>" data-status="Processing" data-item-id="<%= item._id %>">Processing</button>
                            <button class="btn btn-info btn-status <%= item.status !== 'Processing' ? 'disabled' : '' %>" data-status="Shipped" data-item-id="<%= item._id %>">Shipped</button>
                            <button class="btn btn-success btn-status <%= item.status === 'Delivered' || item.status === 'Cancelled' ? 'disabled' : '' %>" data-status="Delivered" data-item-id="<%= item._id %>">Delivered</button>
                            <button class="btn btn-danger btn-status <%= item.status === 'Cancelled' ? 'disabled' : '' %>" data-status="Cancelled" data-item-id="<%= item._id %>">Cancelled</button>
                            <% if (item.isReturnRequested) { %>
                              <input type="hidden" id="orderIdHidden" value="<%= order.orderId %>">
                              <button class="btn btn-warning btn-return-request" data-item-id="<%= item._id %>" data-reason="<%= item.reasonOfReturn %>" data-additional-reason="<%= item.additionalReason %>">View Return Request</button>
                            <% } %>
                          </div>
                        <% }) %>
                      </div>
                      <!-- Return Request Modal -->
                      <div class="modal fade" id="returnRequestModal" tabindex="-1" aria-labelledby="returnRequestModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="returnRequestModalLabel">Return Request Details</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              <p><strong>Reason for Return:</strong> <span id="return-reason"></span></p>
                              <p><strong>Additional Reason:</strong> <span id="additional-reason"></span></p>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-success" id="accept-return">Accept Return</button>
                              <button type="button" class="btn btn-danger" id="decline-return">Decline Return</button>
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Shipping Address -->
                      <div class="col-lg-6 address-details">
                        <h5>Shipping Address</h5>
                        <p><strong>Name:</strong> <%= order.address.fullName %></p>
                        <p><strong>Address:</strong> <%= order.address.streetAddress %></p>
                        <p><strong>City:</strong> <%= order.address.city %></p>
                        <p><strong>Phone:</strong> <%= order.address.phoneNumber %></p>
                        <p><strong>Email:</strong> <%= order.address.emailAddress %></p>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  $(document).ready(function() {
    // Toggle details visibility
    $('.toggle-details-btn').on('click', function() {
      const $parentRow = $(this).closest('tr');
      $parentRow.next('.order-details-row').toggle();
      $(this).text($(this).text() === 'Show Details' ? 'Hide Details' : 'Show Details');
    });

    // Handle product status change
    $('.btn-status').on('click', function() {
      const status = $(this).data('status');
      const itemId = $(this).data('item-id');

      Swal.fire({
        title: `Update the product status to "${status}"?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, update it!'
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            url: '/admin/update-product-status',
            method: 'POST',
            data: { itemId: itemId, status: status },
            success: function(response) {
              if (response.success) {
                Swal.fire(
                  'Updated!',
                  `Product status has been updated to "${status}".`,
                  'success'
                ).then(() => {
                  location.reload(); // Reload the page after successful update
                });
              } else {
                Swal.fire(
                  'Error!',
                  response.message || 'Failed to update the status. Try again.',
                  'error'
                );
              }
            },
            error: function(err) {
              Swal.fire(
                'Failed!',
                'Unable to update the status. Please try again later.',
                'error'
              );
            }
          });
        }
      });
    });
   // Handle return request button click
  $('.btn-return-request').on('click', function() {
    const itemId = $(this).data('item-id');
    const reason = $(this).data('reason');
    const additionalReason = $(this).data('additional-reason');

    // Populate modal with reason details
    $('#return-reason').text(reason);
    $('#additional-reason').text(additionalReason);

    // Store the itemId for future actions
    $('#returnRequestModal').data('item-id', itemId);

    // Open the modal
    $('#returnRequestModal').modal('show');
  });

  // Handle accept return
  $('#accept-return').on('click', function() {
    const itemId = $('#returnRequestModal').data('item-id');
    const orderId = $('#orderIdHidden').val();

    Swal.fire({
      title: 'Are you sure?',
      text: "You are about to accept this return request!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#28a745',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, accept it!'
    }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          url: '/admin/accept-return-request',
          method: 'POST',
          data: { itemId, orderId },
          success: function(response) {
            Swal.fire(
              'Accepted!',
              'The return request has been accepted.',
              'success'
            ).then(() => {
              location.reload();
            });
          },
          error: function(err) {
            Swal.fire(
              'Failed!',
              'Unable to accept the return request. Try again later.',
              'error'
            );
          }
        });
      }
    });
  });

  // Handle decline return
  $('#decline-return').on('click', function() {
    const itemId = $('#returnRequestModal').data('item-id');

    Swal.fire({
      title: 'Are you sure?',
      text: "You are about to decline this return request!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Yes, decline it!'
    }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          url: '/admin/decline-return-request',
          method: 'POST',
          data: { itemId },
          success: function(response) {
            Swal.fire(
              'Declined!',
              'The return request has been declined.',
              'success'
            ).then(() => {
              location.reload();
            });
          },
          error: function(err) {
            Swal.fire(
              'Failed!',
              'Unable to decline the return request. Try again later.',
              'error'
            );
          }
        });
      }
    });
  });
});

</script>
